[TOC]

# What's 词法作用域？
作用域有两种 工作模型。一种是：词法作用域；另一种是动态作用域。
| 词法作用域 | 动态作用域 |
| --- | --- |
| 大部分编程语言都在用<br /> 比如说: `javascript` | 小部分编程语言在用<br /> 比如说: `Bash 脚本`、`Perl 中的一些模式`等 |
> 词法作用域是由你在写代码时将变量和块作用域写在哪里来决定的，因此当词法分析器处理代码时会保持作用域不变。

词法作用域，以我的理解就是，写代码时，决定的作用域，一个函数是一个作用域，一个对象是一个作用域。这些就是写完代码，就决定好的。

## 一.词法阶段
### 那个阶段被称为词法阶段？
> 大部分标准语言编译器的第一个工作阶段叫作词法化（也叫单词化）。
### 词法阶段都干了些什么事情？
> 词法化的过程会对源代码中的字符进行检查，如果是有状态的解析过程，还会赋予单词语义。
### 引擎如何查找标识符？
> 作用域气泡的结构和互相之间的位置关系给引擎提供了足够的位置信息，引擎用这些信息来查找标识符的位置。
### 什么是遮蔽效应？
> 作用域查找会在找到第一个匹配的标识符时停止。在多层的嵌套作用域中可以定义同名的标识符，这叫作“遮蔽效应”（内部的标识符“遮蔽”了外部的标识符）。抛开遮蔽效应，作用域查找始终从运行时所处的最内部作用域开始，逐级向外或者说向上进行，直到遇见第一个匹配的标识符为止。
### 如何访问被遮蔽的标识法？
> **全局变量会自动成为全局对象**（比如浏览器中的 window 对象）的属性，因此可以不直接通过全局对象的词法名称，而是间接地通过对全局对象属性的引用来对其进行访问。比如`window.a`。
**但非全局的变量如果被遮蔽了，无论如何都无法被访问到。**
## 二.欺骗词法
### 有哪些方法可以欺骗词法作用域？
- eval (setTimeout、setInterval、new Function)
    - JavaScript 中的 eval(..) 函数可以接受一个字符串为参数，并将其中的内容视为好像在书写时就存在于程序中这个位置的代码。
- with
    - with 通常被当作重复引用同一个对象中的多个属性的快捷方式，可以不需要重复引用对象本身。
    with 可以将一个没有或有多个属性的对象处理为一个完全隔离的词法作用域，因此这个对象的属性也会被处理为定义在这个作用域中的词法标识符。
    > 尽管 with 块可以将一个对象处理为词法作用域，但是这个块内部正常的 var 声明并不会被限制在这个块的作用域中，而是被添加到 with 所处的函数作用域中。
> 在严格模式的程序中，eval(..) 在运行时有其自己的词法作用域，意味着其中的声明无法修改所在的作用域。with 被完全禁止。
### 欺骗作用于对性能有什么影响？
> &emsp;&emsp;JavaScript 引擎会在编译阶段进行数项的性能优化。其中有些优化依赖于能够根据代码的词法进行静态分析，并预先确定所有变量和函数的定义位置，才能在执行过程中快速找到标识符。
&emsp;&emsp;但如果引擎在代码中发现了 eval(..) 或 with，它只能简单地假设关于标识符位置的判断都是无效的，因为无法在词法分析阶段明确知道 eval(..) 会接收到什么代码，这些代码会如何对作用域进行修改，也无法知道传递给 with 用来创建新词法作用域的对象的内容到底是什么。
&emsp;&emsp;最悲观的情况是如果出现了 eval(..) 或 with，所有的优化可能都是无意义的，因此最简单的做法就是完全不做任何优化。
&emsp;&emsp;如果代码中大量使用 eval(..) 或 with，那么运行起来一定会变得非常慢。无论引擎多聪明，试图将这些悲观情况的副作用限制在最小范围内，也无法避免如果没有这些优化，代码会运行得更慢这个事实。
## 三.小结
> 词法作用域意味着作用域是由书写代码时函数声明的位置来决定的。编译的词法分析阶段基本能够知道全部标识符在哪里以及是如何声明的，从而能够预测在执行过程中如何对它们进行查找。
JavaScript 中有两个机制可以“欺骗”词法作用域：eval(..) 和 with。前者可以对一段包
含一个或多个声明的“代码”字符串进行演算，并借此来修改已经存在的词法作用域（在运行时）。后者本质上是通过将一个对象的引用当作作用域来处理，将对象的属性当作作用域中的标识符来处理，从而创建了一个新的词法作用域（同样是在运行时）。
这两个机制的副作用是引擎无法在编译时对作用域查找进行优化，因为引擎只能谨慎地认为这样的优化是无效的。使用这其中任何一个机制都将导致代码运行变慢。不要使用它们。


## Q&A
1. 在词法化阶段，什么是是有状态的解析过程，赋予单词语义？
    - 猜测是 进行变量声明和函数声明的时候。也有可能不是，因为词法化的时候并没有生成代码，不能进行代码的执行。